<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image encoder</title>

    <div id="secret-container">
        <input type="file" id="fileInput" accept="image/*">
        <label id="hint">Select an image file to encode</label>
        <br>
        <label for="secretInput">Secret:</label>
        <input id="secretInput" placeholder="Enter your secret here">
    </script>

    <hr>
    <div id="button-container">
        <button id="encodeButton">Encode</button>
        <button id="decodeButton">Decode</button>
    </div>

    <div id="output"></div>
</head>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }
    #fileInput {
        display: block;
        margin-bottom: 10px;
    }
    #output img {
        max-width: 100%;
        height: auto;
    }
</style>

<body>
    <script type="module">
        import init, { encode, decode } from './pkg/chaotic_enc.js';

        await init(); // Initialize the WASM module
        const secretInput = document.getElementById('secretInput');
        const fileInput = document.getElementById('fileInput');
        const outputDiv = document.getElementById('output');
        const hintLabel = document.getElementById('hint');
        const encodeButton = document.getElementById('encodeButton');
        const decodeButton = document.getElementById('decodeButton');

        async function getInputBlob() {
            if (fileInput.files.length === 0) {
                throw new Error("No file selected");
            }
            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            return new Uint8Array(arrayBuffer);
        }

        async function showImage(imBlob) {
            const blob = new Blob([imBlob], { type: 'image/png' });
            const url = URL.createObjectURL(blob);

            const imgElem = document.createElement('img');
            imgElem.src = url;
            imgElem.alt = 'Encoded Image';
            outputDiv.innerHTML = ''; // Clear previous output
            outputDiv.appendChild(imgElem);
        }

        async function encode_image() {
            const inputBlob = await getInputBlob();

            hintLabel.textContent = `Encoding...`;
            await new Promise(resolve => setTimeout(resolve, 0)); // Simulate processing delay

            let outputBlob;
            try {
                outputBlob = encode(inputBlob, secretInput.value);
                hintLabel.textContent = `Encode successfully!`;
            }
            catch (error) {
                hintLabel.textContent = `Error encoding: ${error.message}`;
                console.error(error);
                return;
            }
            await showImage(outputBlob);
        }

        async function decode_image() {
            const inputBlob = await getInputBlob();

            hintLabel.textContent = `Decoding...`;
            await new Promise(resolve => setTimeout(resolve, 0)); // Simulate processing delay

            let outputBlob;
            try {
                outputBlob = decode(inputBlob, secretInput.value);
                hintLabel.textContent = `Decode successfully!`;
            }
            catch (error) {
                hintLabel.textContent = `Error decoding: ${error.message}`;
                console.error(error);
                return;
            }
            await showImage(outputBlob);
        }

        encodeButton.addEventListener('click', encode_image);
        decodeButton.addEventListener('click', decode_image);

    </script>
</body>
</html>
